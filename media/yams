#!/bin/bash
# YAMS-inspired CLI for homelab media stack
# Usage: ./yams [command] [options]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Load environment
if [[ -f .env ]]; then
    source .env
fi
CONFIG_DIR="${CONFIG_DIR:-.}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ASCII Art Banner
show_banner() {
    echo -e "${CYAN}"
    cat << 'EOF'
    ╔═══════════════════════════════════════════════════╗
    ║  ╦ ╦╔═╗╔╦╗╔═╗╦  ╔═╗╔╗   ╔╦╗╔═╗╔╦╗╦╔═╗            ║
    ║  ╠═╣║ ║║║║║╣ ║  ╠═╣╠╩╗  ║║║║╣  ║║║╠═╣            ║
    ║  ╩ ╩╚═╝╩ ╩╚═╝╩═╝╩ ╩╚═╝  ╩ ╩╚═╝═╩╝╩╩ ╩            ║
    ╚═══════════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
}

# Help message
show_help() {
    show_banner
    echo "Homelab Media Stack CLI"
    echo ""
    echo -e "${YELLOW}Usage:${NC} ./yams [command] [options]"
    echo ""
    echo -e "${YELLOW}Commands:${NC}"
    echo "  start [service]      Start all services or a specific service"
    echo "  stop [service]       Stop all services or a specific service"
    echo "  restart [service]    Restart all services or a specific service"
    echo "  status               Show status of all services"
    echo "  logs [service]       Show logs for a service (default: all)"
    echo "  destroy              Remove all containers and volumes (with confirmation)"
    echo "  check-vpn            Verify VPN is working correctly"
    echo "  urls                 Show all service URLs"
    echo "  backup [dest]        Backup configs to destination"
    echo "  configure            Run all configuration scripts"
    echo "  scan-library         Trigger Jellyfin library scan"
    echo "  fix-anime            Run anime configuration for Sonarr/Radarr"
    echo "  fix-notifications    Configure Radarr/Sonarr -> Jellyfin notifications"
    echo "  plugins              Configure Jellyfin plugin repositories"
    echo "  --help, -h           Show this help message"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  ./yams start                # Start all services"
    echo "  ./yams restart sonarr       # Restart only Sonarr"
    echo "  ./yams check-vpn            # Verify VPN is working"
    echo "  ./yams backup ~/backups     # Backup to ~/backups"
    echo ""
}

# Get service URLs
show_urls() {
    echo -e "${CYAN}═══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}Service URLs:${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "  ${YELLOW}Arr Stack:${NC}"
    echo "    Sonarr:        http://localhost:${SONARR_PORT:-8989}"
    echo "    Radarr:        http://localhost:${RADARR_PORT:-7878}"
    echo "    Lidarr:        http://localhost:${LIDARR_PORT:-8686}"
    echo "    Prowlarr:      http://localhost:${PROWLARR_PORT:-9696}"
    echo "    Bazarr:        http://localhost:${BAZARR_PORT:-6767}"
    echo ""
    echo -e "  ${YELLOW}Download Clients:${NC}"
    echo "    qBittorrent:   http://localhost:${QBIT_WEBUI_PORT:-8080}"
    echo "    NZBGet:        http://localhost:${NZBGET_PORT:-6789}"
    echo ""
    echo -e "  ${YELLOW}Media Server:${NC}"
    echo "    Jellyfin:      http://localhost:8096"
    echo "    Jellyseerr:    http://localhost:5055"
    echo "    Jellystat:     http://localhost:3000"
    echo ""
    
    # Save to file
    cat > ~/media_services.txt << EOF
# Homelab Media Stack Service URLs
# Generated: $(date)

## Arr Stack
Sonarr:        http://localhost:${SONARR_PORT:-8989}
Radarr:        http://localhost:${RADARR_PORT:-7878}
Lidarr:        http://localhost:${LIDARR_PORT:-8686}
Prowlarr:      http://localhost:${PROWLARR_PORT:-9696}
Bazarr:        http://localhost:${BAZARR_PORT:-6767}

## Download Clients
qBittorrent:   http://localhost:${QBIT_WEBUI_PORT:-8080}
NZBGet:        http://localhost:${NZBGET_PORT:-6789}

## Media Server
Jellyfin:      http://localhost:8096
Jellyseerr:    http://localhost:5055
Jellystat:     http://localhost:3000
EOF
    echo -e "${GREEN}URLs saved to ~/media_services.txt${NC}"
}

# Check VPN status
check_vpn() {
    echo -e "${CYAN}═══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}VPN Status Check${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════${NC}"
    echo ""
    
    # Get real IP
    echo -e "${YELLOW}Checking your real IP address...${NC}"
    REAL_IP=$(curl -s https://ifconfig.me 2>/dev/null || curl -s https://api.ipify.org 2>/dev/null || echo "unknown")
    REAL_COUNTRY=$(curl -s "https://ipinfo.io/${REAL_IP}/country" 2>/dev/null || echo "unknown")
    echo -e "  Your IP:       ${BLUE}$REAL_IP${NC} ($REAL_COUNTRY)"
    
    # Get qBittorrent IP (through VPN)
    echo -e "${YELLOW}Checking qBittorrent's IP (through VPN)...${NC}"
    QBIT_IP=$(docker exec qbittorrent curl -s https://ifconfig.me 2>/dev/null || echo "container not running")
    
    if [[ "$QBIT_IP" == "container not running" ]]; then
        echo -e "  qBittorrent:   ${RED}Container not running${NC}"
        return 1
    fi
    
    QBIT_COUNTRY=$(curl -s "https://ipinfo.io/${QBIT_IP}/country" 2>/dev/null || echo "unknown")
    echo -e "  qBittorrent:   ${BLUE}$QBIT_IP${NC} ($QBIT_COUNTRY)"
    
    echo ""
    if [[ "$REAL_IP" != "$QBIT_IP" ]]; then
        echo -e "${GREEN}✅ VPN is working! IPs are different.${NC}"
    else
        echo -e "${RED}⚠️  WARNING: IPs are the same! VPN might not be working!${NC}"
        return 1
    fi
}

# Show service status
show_status() {
    echo -e "${CYAN}═══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}Service Status${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════${NC}"
    echo ""
    
    # Main stack
    echo -e "${YELLOW}Main Stack:${NC}"
    docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || echo "  Stack not running"
    
    echo ""
    
    # Jellyfin stack
    echo -e "${YELLOW}Jellyfin Stack:${NC}"
    (cd jellyfin && docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null) || echo "  Stack not running"
}

# Start services
start_services() {
    local service="$1"
    
    if [[ -n "$service" ]]; then
        echo -e "${YELLOW}Starting $service...${NC}"
        docker compose up -d "$service" 2>/dev/null || (cd jellyfin && docker compose up -d "$service")
    else
        echo -e "${YELLOW}Starting all services...${NC}"
        docker compose up -d
        (cd jellyfin && docker compose up -d)
    fi
    
    echo -e "${GREEN}✅ Services started!${NC}"
    show_urls
}

# Stop services
stop_services() {
    local service="$1"
    
    if [[ -n "$service" ]]; then
        echo -e "${YELLOW}Stopping $service...${NC}"
        docker compose stop "$service" 2>/dev/null || (cd jellyfin && docker compose stop "$service")
    else
        echo -e "${YELLOW}Stopping all services...${NC}"
        docker compose stop
        (cd jellyfin && docker compose stop)
    fi
    
    echo -e "${GREEN}✅ Services stopped!${NC}"
}

# Restart services
restart_services() {
    local service="$1"
    
    if [[ -n "$service" ]]; then
        echo -e "${YELLOW}Restarting $service...${NC}"
        docker compose restart "$service" 2>/dev/null || (cd jellyfin && docker compose restart "$service")
    else
        echo -e "${YELLOW}Restarting all services...${NC}"
        docker compose restart
        (cd jellyfin && docker compose restart)
    fi
    
    echo -e "${GREEN}✅ Services restarted!${NC}"
}

# Destroy services
destroy_services() {
    echo -e "${RED}⚠️  WARNING: This will destroy all containers and volumes!${NC}"
    echo -e "${RED}All configuration and databases will be lost!${NC}"
    echo ""
    read -p "Are you SURE you want to continue? Type 'yes' to confirm: " confirm
    
    if [[ "$confirm" != "yes" ]]; then
        echo "Aborted."
        return 0
    fi
    
    echo -e "${YELLOW}Destroying all services...${NC}"
    docker compose down -v 2>/dev/null || true
    (cd jellyfin && docker compose down -v 2>/dev/null) || true
    
    echo -e "${GREEN}✅ All services destroyed. Run './yams start' to recreate.${NC}"
}

# Show logs
show_logs() {
    local service="$1"
    
    if [[ -n "$service" ]]; then
        docker compose logs -f "$service" 2>/dev/null || (cd jellyfin && docker compose logs -f "$service")
    else
        docker compose logs -f
    fi
}

# Run configuration
run_configure() {
    echo -e "${YELLOW}Running configuration scripts...${NC}"
    
    if [[ -f scripts/automate_all.sh ]]; then
        bash scripts/automate_all.sh
    else
        echo -e "${RED}automate_all.sh not found${NC}"
        return 1
    fi
}

# Trigger Jellyfin library scan
scan_library() {
    echo -e "${YELLOW}Triggering Jellyfin library scan...${NC}"
    
    # Get Jellyfin API key from jellyseerr settings
    if [[ -f jellyfin/jellyseerr/settings.json ]]; then
        JELLYFIN_API=$(python3 -c "import json; print(json.load(open('jellyfin/jellyseerr/settings.json'))['jellyfin']['apiKey'])" 2>/dev/null)
        
        if [[ -n "$JELLYFIN_API" ]]; then
            curl -s -X POST "http://localhost:8096/Library/Refresh" -H "X-Emby-Token: $JELLYFIN_API"
            echo -e "${GREEN}✅ Library scan triggered!${NC}"
            echo "Check Jellyfin dashboard for progress."
        else
            echo -e "${RED}Could not find Jellyfin API key${NC}"
            return 1
        fi
    else
        echo -e "${RED}Jellyseerr settings not found. Is Jellyfin stack configured?${NC}"
        return 1
    fi
}

# Fix anime configuration
fix_anime() {
    echo -e "${YELLOW}Running anime configuration...${NC}"
    
    if [[ -f scripts/configure_sonarr_anime.sh ]]; then
        echo -e "${CYAN}Configuring Sonarr anime...${NC}"
        bash scripts/configure_sonarr_anime.sh
    fi
    
    if [[ -f scripts/configure_radarr_anime.sh ]]; then
        echo -e "${CYAN}Configuring Radarr anime...${NC}"
        bash scripts/configure_radarr_anime.sh
    fi
    
    if [[ -f scripts/configure_jellyseerr_anime.sh ]]; then
        echo -e "${CYAN}Configuring Jellyseerr anime...${NC}"
        bash scripts/configure_jellyseerr_anime.sh
    fi
    
    echo -e "${GREEN}✅ Anime configuration complete!${NC}"
}

# Configure Jellyfin notifications
fix_notifications() {
    echo -e "${YELLOW}Configuring Jellyfin notifications...${NC}"
    
    if [[ -f scripts/configure_jellyfin_notifications.sh ]]; then
        bash scripts/configure_jellyfin_notifications.sh
    else
        echo -e "${RED}configure_jellyfin_notifications.sh not found${NC}"
        return 1
    fi
}

# Setup Jellyfin plugins
setup_plugins() {
    echo -e "${YELLOW}Configuring Jellyfin plugins...${NC}"
    
    if [[ -f scripts/configure_jellyfin_plugins.sh ]]; then
        bash scripts/configure_jellyfin_plugins.sh
    else
        echo -e "${RED}configure_jellyfin_plugins.sh not found${NC}"
        return 1
    fi
}

# Backup
run_backup() {
    local dest="${1:-./backups}"
    
    echo -e "${YELLOW}Backing up to $dest...${NC}"
    
    if [[ -f backup.sh ]]; then
        bash backup.sh "$dest"
    else
        echo -e "${RED}backup.sh not found${NC}"
        return 1
    fi
}

# Main command router
case "${1:-}" in
    start)
        start_services "$2"
        ;;
    stop)
        stop_services "$2"
        ;;
    restart)
        restart_services "$2"
        ;;
    status)
        show_status
        ;;
    logs)
        show_logs "$2"
        ;;
    destroy)
        destroy_services
        ;;
    check-vpn)
        check_vpn
        ;;
    urls)
        show_urls
        ;;
    backup)
        run_backup "$2"
        ;;
    configure)
        run_configure
        ;;
    scan-library)
        scan_library
        ;;
    fix-anime)
        fix_anime
        ;;
    fix-notifications)
        fix_notifications
        ;;
    plugins)
        setup_plugins
        ;;
    --help|-h|"")
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run './yams --help' for usage information."
        exit 1
        ;;
esac
